import defaults from "./defaults";
import { GrayMatterOption } from "./types";

const excerpt = (file: any, options: GrayMatterOption<any, any>) => {
  const opts = defaults(options);

  if (file.data == null) {
    file.data = {};
  }

  if (typeof opts.excerpt === "function") {
    return opts.excerpt(file, opts);
  }

  const sep = file.data.excerpt_separator || opts.excerpt_separator;
  if (sep == null && (opts.excerpt === false || opts.excerpt == null)) {
    return file;
  }

  const delimiter =
    typeof opts.excerpt === "string"
      ? opts.excerpt
      : sep || (opts.delimiters as any)[0];

  // if enabled, get the excerpt defined after front-matter
  const idx = file.content.indexOf(delimiter);
  if (idx !== -1) {
    file.excerpt = file.content.slice(0, idx);
  }

  return file;
};

export default excerpt;
